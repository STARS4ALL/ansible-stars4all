---

- name: create tessdb config directory if does not exists
  file: 
    path: '{{ new_tdb_etc_dir }}'
    state: directory
    owner: '{{ new_tdb_runtime_user }}'
    group: '{{ new_tdb_runtime_user }}'
    mode: '0755'

- name: copy tessdb config.toml file
  template:
    dest: '{{ new_tdb_etc_dir }}/config.toml'
    src: config.toml.j2
    owner: '{{ new_tdb_runtime_user }}'
    group: '{{ new_tdb_runtime_user }}'
    mode: '0644'

- name: install environment file for tess-db-server service unit
  template:
    dest: '{{ new_tdb_etc_dir }}/tessdb.env'
    src: tessdb.env.j2
    owner: '{{ new_tdb_runtime_user }}'
    group: '{{ new_tdb_runtime_user }}'
    mode: '0644'

- name: install environment file for tess-db-alarm service unit
  template:
    dest: '{{ new_tdb_etc_dir }}/tdbalarm.env'
    src: tdbalarm.env.j2
    owner: '{{ new_tdb_runtime_user }}'
    group: '{{ new_tdb_runtime_user }}'
    mode: '0644'


- name: create tessdb database directory if does not exists
  file: 
    path: '{{ new_tdb_dbase_dir }}'
    state: directory
    owner: '{{ new_tdb_runtime_user }}'
    group: '{{ new_tdb_runtime_user }}'
    mode: '0755'

- name: Manage the SELinux state of database directory
  sefcontext:
    target: '{{ new_tdb_dbase_dir }}'
    ftype: d
    setype: var_log_t
    seuser: unconfined_u
    state: present
  register: new_tdb_selinux_context
  when: new_tdb_selinux_enabled
  tags: [config]

- name: Apply SELinux context changes
  command: restorecon -v {{ new_tdb_dbase_dir | quote }}
  when: new_tdb_selinux_enabled and new_tdb_selinux_context is changed

# File owner for this logrotate spec should be root
# as discovered by manually running logrotate
- name: Patches tessdb logrotate
  template: 
    dest: /etc/logrotate_astro.d/tessdb
    src: logrotate.j2
    owner: root
    group: root
    mode: '0644'

- name: Makes sure {{ new_tdb_service_dir }} exists
  file: 
    path: '{{ new_tdb_service_dir }}'
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Install a tessdb service unit
  template:
    dest: '{{ new_tdb_service_dir }}/tessdb.service'
    src: tessdb.service.j2
    owner: root
    group: root
    mode: '0644'
  register: new_tdb_systemd_changed

# This was necesary pre ansible 2.2
#- name: systemd daemon reload  
#  command: systemctl daemon-reload
#  when:new_tdb_systemd_changed is changed



