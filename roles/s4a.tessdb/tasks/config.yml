---
# tasks file for roles/nto.tessdb

- name: create tessdb config directory if does not exists
  file: >
    path=/etc/tessdb
    state=directory
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0755

- name: copy tessdb main configuration file
  template: >
    dest=/etc/tessdb/config
    src=config.j2
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0644
  notify: restart tessdb service

- name: create tessdb database directory if does not exists
  file: >
    path={{ tessdb_dbase_dir }}
    state=directory
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0755

- name: Patches tessdb logrotate
  template: >
    dest=/etc/logrotate_astro.d/tessdb
    src=logrotate.j2
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0644

- name: Patches tessdb.service to include a virtualenv
  template: >
    dest=/lib/systemd/system/tessdb.service
    src=tessdb.service.j2
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0644
  register: tessdb_systemd_changed

- name: systemd daemon reload  
  command: systemctl daemon-reload
  when: tessdb_systemd_changed

- name: install environment file for virtualenv
  template: >
    dest=/etc/tessdb/tessdb.env
    src=tessdb.env.j2
    owner={{ tessdb_runtime_user }}
    group={{ tessdb_runtime_user }}
    mode=0644
  notify: restart tessdb service

- name: Touch the tess.db database file
  file:
    path: '{{ tessdb_dbase_dir }}/tess.db'
    state: touch
    owner: '{{ tessdb_runtime_user }}'
    group: '{{ tessdb_runtime_user }}'
    mode: '0644'

